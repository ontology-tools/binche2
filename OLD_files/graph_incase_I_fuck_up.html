{% extends "base.html" %}

{% block head %}
{{ super()}} <!-- Retain any head content from base.html -->
<title>Graph Visualisation</title>

<!-- Cytoscape -->
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

<!-- jQuery + qTip2 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>

<!-- Cytoscape-qTip extension -->
<script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip@2.7.0/cytoscape-qtip.min.js"></script>


<style>
    #cy {
        width: 90vw;
        height: 80vh;
        border: 6px solid #000000;
        display: block;
    }
</style>
{% endblock %}

{% block body %}
<h1>Enrichment</h1>
<div id="cy"></div>

<div id="color-legend">
    <h4>Significance</h4>
    <div class="legend-container">
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>Low (1.0)</span>
            <span id="legend-max">High</span>
        </div>
    </div>
</div>

<script>
    fetch("{{url_for('static', filename='data/graph.json')}}")
    .then(response => response.json())
    .then(data => {
        var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: data.elements,

            selectionType: 'additive', // Allow multiple node selection 

            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': 'data(color)',
                        'label': 'data(short_label)',
                        'width': 30,
                        'height': 30,
                        'font-size': 10,
                        'text-valign': 'bottom',
                        'text-halign': 'center',
                        'color': '#000',
                        'border-width': 1,
                        'border-color': '#555'

                    }
                },
                // Style for selected nodes
                {
                    selector: 'node:selected',
                    style: {
                        'border-width': 5,
                        'border-color': '#0540e3' // Blue color for selected nodes
                    }
                },

                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#888',
                        'target-arrow-color': '#888',
                        'target-arrow-shape': 'triangle',   
                        'curve-style': 'bezier'
                    }
                }
            ],
            layout: {
                name: 'breadthfirst',
                directed: true,
                padding: 10
            }
        });

        /////////
        // Dynamic colouring based on p-value
        /////////

        // Collect maximum value
        let maxExponent = 0;


        cy.nodes().forEach(node =>{
            const p = node.data('p_value_corrected') || node.data('p_value'); // Use corrected p-value if available, else raw p-value
            if (p != null && p > 0) {
                const exp = -Math.log10(p);
                if (exp > maxExponent) maxExponent = exp;

            }
        });

        // Update legend with actual max value
        const maxPvalue = Math.pow(10, -maxExponent);
        document.getElementById('legend-max').textContent = `High (${maxPvalue.toExponential(1)})`;

        // Convert hex to RGB
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            return {
                r: parseInt(hex.substring(0, 2), 16),
                g: parseInt(hex.substring(2, 4), 16),
                b: parseInt(hex.substring(4, 6), 16)
            };
        }

        // Linear interpolation between two colors
        function interpolateColor(colorLow, colorHigh, t) {
            const c1 = hexToRgb(colorLow);
            const c2 = hexToRgb(colorHigh);

            const r = Math.round(c1.r + (c2.r - c1.r) * t);
            const g = Math.round(c1.g + (c2.g - c1.g) * t);
            const b = Math.round(c1.b + (c2.b - c1.b) * t);
            return `rgb(${r},${g},${b})`;
        }

        // Update node colours based on p-value
        const colorLow = "#ca3900";  
        const colorHigh = "#ffffff";  

        cy.nodes().forEach(node => {
            const p = node.data('p_value_corrected') || node.data('p_value'); // Use corrected p-value if available, else raw p-value

            let color = "lightgrey"; // default color

            if (p != null && p > 0) {
                const exponent = -Math.log10(p);
                let t = exponent / maxExponent;
                t = Math.max(0, Math.min(1, t)); // Clamp t between 0 and 1

                color = interpolateColor(colorLow, colorHigh, t);
      }

            node.style('background-color', color);
        });

        // Add right-click
        cy.on('cxttap', 'node', function(evt){
            const node = evt.target;
            node.select();
        });
        

        // Add tooltip to hover over nodes
        cy.nodes().forEach(function(node) {
            const pValue = node.data('p_value');
            const pValueCorr = node.data('p_value_corrected');
            
            // Format to 2 decimal places in exponential notation (gives 3 significant figures)
            const formattedPValue = pValue != null ? pValue.toExponential(2) : 'N/A';
            const formattedPValueCorr = pValueCorr != null ? pValueCorr.toExponential(2) : 'N/A';
            
            node.qtip({
                content: `
                    <b>${node.data('label')}</b><br>
                    p-value: ${formattedPValue}<br> 
                    corr. p-value: ${formattedPValueCorr}
                `,
                show: {event: 'mouseover'},
                hide: {event: 'mouseout'},
            })
        });
    });
</script>

<a href="/" 
   style="display:inline-block; padding:8px 16px; margin-top:20px; 
          background:#0f808d; color: white; text-decoration:none; 
          border-radius:4px;">
    Back to homepage
</a>

{% endblock %}