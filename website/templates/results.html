{% extends "base.html" %}

{% block head %}
<title>Enrichment Results</title>
{% endblock %}

{% block body %}
<h1>Enrichment Analysis Results</h1>
<p>Analysed leaves: {{results.study_set}}</p>
<p>Removed nodes: {{results.removed_nodes}}</p> 

<a href="#" id="downloadCsv"
style="display:inline-block; padding:8px 16px; margin-top:20px; 
          background:#ee1e97; color: white; text-decoration:none; 
          border-radius:4px;">
    Download Results (CSV)
</a>

<a href="{{url_for('graph')}}" 
   style="display:inline-block; padding:8px 16px; margin-top:20px; 
          background:#8d0f83; color: white; text-decoration:none; 
          border-radius:4px;">
    View Graph
</a>

<a href="/" 
   style="display:inline-block; padding:8px 16px; margin-top:20px; 
          background:#0f808d; color: white; text-decoration:none; 
          border-radius:4px;">
    Back to homepage
</a>


<br><br>
<h2>Enrichment results:</h2>
<table border="1" cellpadding="10" cellspacing="0">
    <thead>
        <tr>
            <th>Class</th>
            <th>Raw p-value</th>
            <th>Corrected p-value</th>
        </tr>
    </thead>
    <tbody>
        {% for item in results.enrichment_results.values() %}
        <tr>
            <td>{{ item.class }}</td>
            <td>{{ "%.4e"|format(item.p_value) }}</td>
            <td>
                {% if item.get('p_value_corrected')%}
                    {{ "%.4e"|format(item.p_value_corrected) }}
                {% else %}
                    N/A
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>

</table>

<script> // Not ideal since this is mixing Jinja2 template syntax (server-side) with JavaScript (client-side) but it works for now.
document.getElementById('downloadCsv').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Create CSV content
    let csv = 'Class,Raw p-value,Corrected p-value\n';
    
    {% for item in results.enrichment_results.values() %}
    csv += '{{ item.class }},' + 
        '{{ "%.4e"|format(item.p_value) }},' + 
        '{% if item.get("p_value_corrected") %}{{ "%.4e"|format(item.p_value_corrected) }}{% else %}N/A{% endif %}\n';
    {% endfor %}
    
    // Create download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'enrichment_results.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
});
</script>

{% endblock %}