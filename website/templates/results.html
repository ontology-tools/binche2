{% extends "base.html" %}

{% block head %}
<title>Enrichment Results</title>
<style>
#downloadCsv:hover {
    background: #3da8b8 !important;
    border-color: #3da8b8 !important;
}
.muted-log {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}
.results-table th:nth-child(2),
.results-table th:nth-child(3),
.results-table td:nth-child(2),
.results-table td:nth-child(3) {
    padding-left: 10px;
    padding-right: 10px;
}
.grey {
    color: #6c757d;
}
</style>
{% endblock %}

{% block body %}
<div style="padding: 20px 40px;">
<h3 class="mt-4 mb-3">Enrichment Analysis Results</h3>

<a href="#" id="downloadCsv" class="btn btn-primary"
    style="background:#0f808d; border-color:#0f808d; margin:20px 5px 20px 0;">
    Download Results (CSV)
</a>

<a href="{{url_for('graph')}}" class="btn btn-primary"
    style="margin:20px 0 20px 5px;">
    View Graph
</a>


<br><br>
<h4 class="mt-4 mb-3">Results Table</h4>
<table cellpadding="10" cellspacing="0" class="table table-striped table-bordered results-table">
    <thead>
        <tr>
            <th>Class</th>
            <th>Raw p-value</th>
            <th>Corr. p-value</th>
        </tr>
    </thead>
    <tbody>
        {% for item in results.enrichment_results.values() %}
        <tr>
            <td>{{ item.class }}</td>
            <td>{{ "%.4e"|format(item.p_value) }}</td>
            <td>
                {% if item.get('p_value_corrected')%}
                    {{ "%.4e"|format(item.p_value_corrected) }}
                {% else %}
                    N/A
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>

</table>

<h2 class="grey"> Log of Analysis </h2>
<p class="muted-log">Analysed leaves: {{results.study_set}}</p>
<p class="muted-log">Removed nodes: {{results.removed_nodes}}</p>

<script> // Not ideal since this is mixing Jinja2 template syntax (server-side) with JavaScript (client-side) but it works for now.
document.getElementById('downloadCsv').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Create CSV content
    let csv = 'Class,Raw p-value,Corrected p-value\n';
    
    {% for item in results.enrichment_results.values() %}
    csv += '{{ item.class }},' + 
        '{{ "%.4e"|format(item.p_value) }},' + 
        '{% if item.get("p_value_corrected") %}{{ "%.4e"|format(item.p_value_corrected) }}{% else %}N/A{% endif %}\n';
    {% endfor %}
    
    // Create download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'enrichment_results.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
});
</script>

</div>

{% endblock %}