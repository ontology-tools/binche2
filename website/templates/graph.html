{% extends "base.html" %}

{% block head %}
{{ super()}} <!-- Retain any head content from base.html -->
<title>Graph Visualisation</title>

<!-- Cytoscape -->
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

<!-- jQuery + qTip2 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>

<!-- Cytoscape-qTip extension -->
<script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip@2.7.0/cytoscape-qtip.min.js"></script>

{% endblock %}

{% block nav_items %}

<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="exportDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fa fa-download"></i> Export
    </a>
    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
        <li><a href="#" class="dropdown-item export-option" data-format="png">Export as PNG</a></li>
        <li><a href="#" class="dropdown-item export-option" data-format="jpeg">Export as JPEG</a></li>
    </ul>
</li>

<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="layoutDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fa fa-sitemap"></i> Layout
    </a>
    <ul class="dropdown-menu" aria-labelledby="layoutDropdown">
        <li><a href="#" class="dropdown-item layout-option" data-layout="breadthfirst">Breadthfirst</a></li>
        <li><a href="#" class="dropdown-item layout-option" data-layout="cose">Cose</a></li>
        <li><a href="#" class="dropdown-item layout-option" data-layout="grid">Grid</a></li>
        <li><a href="#" class="dropdown-item layout-option" data-layout="circle">Circle</a></li>
    </ul>
</li>

<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="showHideDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fa fa-eye"></i> Show/Hide
    </a>
    <ul class="dropdown-menu" aria-labelledby="showHideDropdown">
        <li><a href="#" class="dropdown-item show-hide-option" data-action="hide-unselected">Show selected only</a></li>
        <li><a href="#" class="dropdown-item show-hide-option" data-action="hide-selected">Hide selected</a></li>
        <li><a href="#" class="dropdown-item show-hide-option" data-action="show-all">Show all nodes</a></li>
        <li><a href="#" class="dropdown-item show-hide-option" data-action="hide-non-significant">Hide non-significant nodes</a></li>
        <li><a href="#" class="dropdown-item show-hide-option" data-action="hide-labels">Hide/Show labels</a></li>
    </ul>
</li>

<li class="nav-item">
    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#pruningModal">
        <i class="fa fa-sliders"></i> Settings
    </a>
</li>

{% endblock %}

{% block body %}

<div class="graph-wrapper">

    <div id="cy"></div>

    <div id="color-legend">
    <div id="legend-title"></div>
    <div class="legend-container">
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>Low </span>
            <span id="legend-max">High</span>
        </div>
    </div>
    <p class="text-muted">(−log₁₀ scale)</p>

</div>
</div>

<script>

</script>


<script>
    fetch("{{url_for('static', filename='data/' ~ graph_file)}}")
    .then(response => response.json())
    .then(data => {
        var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: data.elements,

            selectionType: 'additive', // Allow multiple node selection 

            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': 'data(color)',
                        'label': 'data(short_label)',
                        'width': 30,
                        'height': 30,
                        'font-size': 10,
                        'text-valign': 'bottom',
                        'text-halign': 'center',
                        'color': '#000',
                        'border-width': 1,
                        'border-color': '#555'

                    }
                },
                // Style for selected nodes
                {
                    selector: 'node:selected',
                    style: {
                        'border-width': 5,
                        'border-color': '#0540e3' // Blue color for selected nodes
                    }
                },

                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#888',
                        'target-arrow-color': '#888',
                        'target-arrow-shape': 'triangle',   
                        'curve-style': 'bezier'
                    }
                }
            ],
            layout: {
                name: 'cose',
                directed: true,
                padding: 10,
            }
        });

        let labelsVisible = true;

 10
        // Flip the graph vertically to have roots at the top
        cy.nodes().forEach(node => {
            const pos = node.position();
            node.position({ x: pos.x, y: -pos.y });
        });

        // Center the graph in the viewport
        cy.fit(50); // 50px padding

        /////////
        // Colouring
        /////////

        const colourScaleMode = 'relative'; // 'absolute' or 'relative'

        const absoluteMaxExponent = 4; // Colour saturation point: p >= 1e-maxExponent all map to max significance

        if (colourScaleMode == 'relative') {
            // Determine max exponent from data
            var maxExponent = 0;
            cy.nodes().forEach(node => {
                const p = node.data('p_value_corrected') || node.data('p_value'); // Use corrected p-value if available, else raw p-value
                if (p != null && p > 0) {
                    const exponent = -Math.log10(p);
                    if (exponent > maxExponent) {
                        maxExponent = exponent;
                    }
                }
            });
        } else if (colourScaleMode == 'absolute') {
            var maxExponent = absoluteMaxExponent;
        } else {
            throw new Error("Invalid colour scale mode");
        }

        // Update legend
        document.getElementById('legend-max').textContent =
            `High (p ≤ ${Math.pow(10, -maxExponent).toExponential(1) })`;
        
        const titleDiv = document.getElementById('legend-title');

        if (colourScaleMode === 'relative') {
            titleDiv.innerHTML = '<h4 class="mb-1">Significance (relative)</h4>';
        } else {
            titleDiv.innerHTML = '<h4 class="mb-1">Significance</h4>';
        }
                


        // Convert hex to RGB
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            return {
                r: parseInt(hex.substring(0, 2), 16),
                g: parseInt(hex.substring(2, 4), 16),
                b: parseInt(hex.substring(4, 6), 16)
            };
        }

        // Linear interpolation between two colors
        function interpolateColor(colorLow, colorHigh, t) {
            const c1 = hexToRgb(colorLow);
            const c2 = hexToRgb(colorHigh);

            const r = Math.round(c1.r + (c2.r - c1.r) * t);
            const g = Math.round(c1.g + (c2.g - c1.g) * t);
            const b = Math.round(c1.b + (c2.b - c1.b) * t);
            return `rgb(${r},${g},${b})`;
        }

        // Update node colours based on p-value
        const colorLow = "#ca3900";  
        const colorHigh = "#ffffff";  

        cy.nodes().forEach(node => {
            const p = node.data('p_value_corrected') || node.data('p_value'); // Use corrected p-value if available, else raw p-value

            let color = "lightgrey"; // default color

            if (p != null) {
                const exponent = -Math.log10(p);
                let t = exponent / maxExponent;
                t = 1 - t; // Invert t so that low p-values are high t
                t = Math.max(0, Math.min(1, t)); // Clamp t between 0 and 1

                color = interpolateColor(colorLow, colorHigh, t);
      }

            node.style('background-color', color);
        });

        
        // Add tooltip to hover over nodes
        cy.nodes().forEach(function(node) {
            const pValue = node.data('p_value');
            const pValueCorr = node.data('p_value_corrected');
            
            // Format to 2 decimal places in exponential notation (gives 3 significant figures)
            const formattedPValue = pValue != null ? pValue.toExponential(2) : 'N/A';
            const formattedPValueCorr = pValueCorr != null ? pValueCorr.toExponential(2) : 'N/A';
            
            node.qtip({
                content: `
                    <b>${node.data('label')}</b><br>
                    p-value: ${formattedPValue}<br> 
                    corr. p-value: ${formattedPValueCorr}
                `,
                show: {event: 'mouseover'},
                hide: {event: 'mouseout'},
            })
        });

        // Custom context menu div
        const contextMenu = document.createElement('div');
        contextMenu.id = 'context-menu';
        contextMenu.style.cssText = 'position:absolute; display:none; background:white; border:1px solid #ccc; box-shadow:2px 2px 5px rgba(0,0,0,0.2); z-index:1000; padding:5px 0;';
        document.body.appendChild(contextMenu);

        let selectedNode = null;

        cy.on('cxttap', 'node', function(evt){
            evt.preventDefault();
            selectedNode = evt.target;
            
            // Position menu at mouse coordinates
            contextMenu.style.left = evt.originalEvent.pageX + 'px';
            contextMenu.style.top = evt.originalEvent.pageY + 'px';
            
            //// Build menu content
            // const pValue = selectedNode.data('p_value');
            // const pValueCorr = selectedNode.data('p_value_corrected');
            
            contextMenu.innerHTML = `
                <div style="padding:8px 16px; cursor:pointer; hover:background:#f0f0f0;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="window.selectNode()">Select Node</div>
                <div style="padding:8px 16px; cursor:pointer;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="window.selectNeighbors()">Select first neighbors</div>
                <div style="padding:8px 16px; cursor:pointer;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="window.selectDescendants()">Select descendants</div>
            `;
            
            contextMenu.style.display = 'block';
        });

        // Hide menu when clicking elsewhere
        document.addEventListener('click', function() {
            contextMenu.style.display = 'none';
        });

        // Menu actions
        window.selectNode = function() {
            if (selectedNode) selectedNode.select();
            contextMenu.style.display = 'none';
        };

        // window.showDetails = function() {
        //     if (selectedNode) {
        //         const pValue = selectedNode.data('p_value');
        //         const pValueCorr = selectedNode.data('p_value_corrected');
        //         alert(`Node: ${selectedNode.data('label')}\np-value: ${pValue?.toExponential(2) || 'N/A'}\nCorrected p-value: ${pValueCorr?.toExponential(2) || 'N/A'}`);
        //     }
        //     contextMenu.style.display = 'none';
        // };

        window.selectNeighbors = function() {
            if (selectedNode) {
                selectedNode.neighborhood().select();
            }
            contextMenu.style.display = 'none';
        };

        window.selectDescendants = function() {
            if (selectedNode) {
                // Select all descendants (this will be predecessors due to the directed nature of the graph)
                const descendants = selectedNode.predecessors();
                descendants.select();
            }
            contextMenu.style.display = 'none';
        };

        // Main menu actions

        // Export graph
        document.querySelectorAll('.export-option').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault(); // stop link navigation

                const format = e.target.dataset.format;

                switch(format) {
                    case 'png':
                        const pngData = cy.png({full: true, scale: 2});
                        const link = document.createElement('a');
                        link.href = pngData;
                        link.download = 'graph.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        break;

                    case 'jpeg':
                        const jpegData = cy.jpeg({full: true, scale: 2, quality: 0.9});
                        const linkJpeg = document.createElement('a');
                        linkJpeg.href = jpegData;
                        linkJpeg.download = 'graph.jpeg';
                        document.body.appendChild(linkJpeg);
                        linkJpeg.click();
                        document.body.removeChild(linkJpeg);
                        break;
                }
            });
        });

        // Layout change
        document.querySelectorAll('.layout-option').forEach(item => {
        item.addEventListener('click', e => {
            e.preventDefault(); // stop link navigation

            const layoutName = e.target.dataset.layout;

            cy.layout({
                name: layoutName,
                directed: true,
                padding: 10,
            }).run();

            // Flip the graph vertically to have roots at the top
            cy.nodes().forEach(node => {
                const pos = node.position();
                node.position({ x: pos.x, y: -pos.y });
            });

            // Center the graph in the viewport
            cy.fit(50); // 50px padding
        });
        });

        // Hide leaf nodes with no p-value (all proper leaves)
        cy.nodes().forEach(node => {
            const p = node.data('p_value_corrected') ?? node.data('p_value');
            // If p-value is not available, check if it is a leaf by indegree. If so, hide it.
            if (p == null && node.indegree() === 0) {
                node.style('display', 'none');
                // Also hide connected edges
                node.connectedEdges().style('display', 'none');
            }
        });

        // Show/hide nodes when respective menu item is clicked
        document.querySelectorAll('.show-hide-option').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault(); // stop link navigation
                
                const action = e.target.dataset.action;
                
                switch(action) {
                    case 'hide-unselected':
                        // Hide all nodes that are not selected
                        cy.nodes(':unselected').style('display', 'none');
                        // Also hide edges connected to hidden nodes
                        cy.nodes(':unselected').connectedEdges().style('display', 'none');
                        break;
                        
                    case 'hide-selected':
                        // Hide all selected nodes
                        cy.nodes(':selected').style('display', 'none');
                        // Also hide edges connected to hidden nodes
                        cy.nodes(':selected').connectedEdges().style('display', 'none');
                        break;
                        
                    case 'show-all':
                        // Show all nodes and edges
                        cy.nodes().style('display', 'element');
                        cy.edges().style('display', 'element');
                        
                        // Hide leaf nodes with no p-value (all proper leaves)
                        cy.nodes().forEach(node => {
                            const p = node.data('p_value_corrected') ?? node.data('p_value');
                            if (p == null && node.indegree() === 0) {
                                node.style('display', 'none');
                                node.connectedEdges().style('display', 'none');
                            }
                        });
                        break;

                    case 'hide-labels':
                    
                        labelsVisible = !labelsVisible;

                        cy.style()
                        .selector('node')
                        .style({
                            'label': labelsVisible ? 'data(short_label)' : ''
                        })
                        .update();

                        break;

                    case 'hide-non-significant':
                        // Hide nodes with p-value (corrected if available) above 0.05 and p-value N/A nodes
                        cy.nodes().forEach(node => {
                            const p = node.data('p_value_corrected') ?? node.data('p_value');
                            if (p != null && p > 0.05) {
                                node.style('display', 'none');
                                // Also hide connected edges
                                node.connectedEdges().style('display', 'none');
                            }
                            if (p == null) {
                                node.style('display', 'none');
                                // Also hide connected edges
                                node.connectedEdges().style('display', 'none');
                            }
                        });
                        break;

                }
            });
        });


    });

</script>

<!-- Pruning Modal -->
<div class="modal fade" id="pruningModal" tabindex="-1" aria-labelledby="pruningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pruningModalLabel">Change Target, Correction Method, and Pruning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/run_analysis" method="POST" id="pruningForm">
                    <!-- CLASSIFICATION -->
                    <div class="mb-3">
                        <h6>Target of Enrichment:</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="classification" id="classification_structural" value="structural" 
                            {% if classification == 'structural' %} checked {% endif %} required>
                            <label class="form-check-label" for="classification_structural">
                                Structure
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="classification" id="classification_functional" value="functional"
                            {% if classification == 'functional' %} checked {% endif %}>
                            <label class="form-check-label" for="classification_functional">
                                Role
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="classification" id="classification_full" value="full"
                            {% if classification == 'full' %} checked {% endif %}>
                            <label class="form-check-label" for="classification_full">
                                Both
                            </label>
                        </div>
                    </div>
                    <hr class="my-3" style="opacity: 0.3;">

                    <!-- LOOPING PRUNING METHOD -->
                    <div class="mb-3">
                        <h6>Looping Pruning Method:</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="looping_prune_method" id="plain_enrich" value="plain_enrich" 
                            {% if pruning.get('method') == 'plain_enrich' %} checked {% endif %} required>
                            <label class="form-check-label" for="plain_enrich">
                                Plain enrichment pruning strategy
                                <small class="d-block text-muted">(no further selections needed)</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="looping_prune_method" id="no_loop_prune" value="no_loop_prune"
                            {% if pruning.get('method') == 'custom' %} checked {% endif %}>
                            <label class="form-check-label" for="no_loop_prune">
                                No looping pruning
                                <small class="d-block text-muted">(customise pruning options below)</small>
                            </label>
                        </div>
                    </div>

                    <!-- P-VALUE CORRECTION METHOD -->
                    <div class="mb-3">
                        <label for="p_value_correction_method" class="form-label">P-value correction method:</label>
                        <select name="p_value_correction_method" id="p_value_correction_method" class="form-select">
                            <option value="benjamini_hochberg" {% if correction_method.get('benjamini_hochberg_correct') %} selected {% endif %}>Benjamini-Hochberg</option>
                            <option value="bonferroni" {% if correction_method.get('bonferroni_correct') %} selected {% endif %}>Bonferroni</option>
                            <option value="none" {% if not correction_method.get('bonferroni_correct') and not correction_method.get('benjamini_hochberg_correct') %} selected {% endif %}>None</option>
                        </select>
                    </div>

                    <!-- ROOT CHILDREN PRUNE -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="root_children_prune" id="root_children_prune" value="true"
                            {% if pruning.get('root_children_prune') %} checked {% endif %}>
                            <label class="form-check-label" for="root_children_prune">
                                Root-children pruning
                            </label>
                        </div>
                        <div class="ms-4 mt-2">
                            <label for="levels" class="form-label small text-muted">Levels (to prune including root):</label>
                            <input type="number" name="levels" id="levels" min="0" value="{{ pruning.get('levels', 2) }}" class="form-control" style="max-width:100px;">
                        </div>
                    </div>

                    <!-- LINEAR BRANCH PRUNE -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="linear_branch_prune" id="linear_branch_prune" value="true"
                            {% if pruning.get('linear_branch_prune') %} checked {% endif %}>
                            <label class="form-check-label" for="linear_branch_prune">
                                Linear branch pruning
                            </label>
                        </div>
                        <div class="ms-4 mt-2">
                            <label for="linear_branch_n" class="form-label small text-muted">n (keep every n:th node):</label>
                            <input type="number" name="linear_branch_n" id="linear_branch_n" min="0" value="{{ pruning.get('linear_branch_n', 2) }}" class="form-control" style="max-width:100px;">
                        </div>
                    </div>

                    <!-- HIGH P-VALUE PRUNE -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="high_p_value_prune" id="high_p_value_prune" value="true"
                            {% if pruning.get('high_p_value_prune') %} checked {% endif %}>
                            <label class="form-check-label" for="high_p_value_prune">
                                High p-value pruning
                            </label>
                        </div>
                        <div class="ms-4 mt-2">
                            <label for="p_value_threshold" class="form-label small text-muted">p-value threshold:</label>
                            <input type="number" name="p_value_threshold" id="p_value_threshold" step="0.01" min="0" max="1" value="{{ pruning.get('p_value_threshold', 0.05) }}" class="form-control" style="max-width:100px;">
                        </div>
                    </div>

                    <!-- ZERO DEGREE PRUNE -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="zero_degree_prune" id="zero_degree_prune" value="true"
                            {% if pruning.get('zero_degree_prune') %} checked {% endif %}>
                            <label class="form-check-label" for="zero_degree_prune">
                                Zero-degree pruning
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-start">
                <button type="submit" form="pruningForm" class="btn btn-primary">Re-run enrichment calculations</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}